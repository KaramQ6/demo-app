# تحديثات مكون الشات بوت وصفحة خطتي وتفضيلات المستخدم

## ما تم تنفيذه:

### 1. تحديث مكون الشات (`Chatbot.js`)
- ✅ إضافة زر "أضف إلى خطتي" عندما يقترح جواد وجهة
- ✅ التحقق التلقائي من النصوص التي تحتوي على أسماء الوجهات
- ✅ إرسال طلب POST إلى webhook عند النقر على الزر
- ✅ إضافة حالات تحميل وأخطاء

**الوجهات المدعومة حالياً:**
- البتراء / Petra
- جرش / Jerash  
- وادي رم / Wadi Rum
- العقبة / Aqaba
- عمان / Amman
- البحر الميت / Dead Sea

### 2. إنشاء صفحة "خطتي" (`/my-plan`)
- ✅ جلب الوجهات المحفوظة من قاعدة البيانات
- ✅ عرض بطاقات الوجهات مع التفاصيل
- ✅ إمكانية حذف الوجهات من الخطة
- ✅ تصميم responsive ومتعدد اللغات
- ✅ حماية الصفحة (للمستخدمين المسجلين فقط)

### 3. تحديث Header
- ✅ إظهار/إخفاء الروابط حسب حالة المستخدم
- ✅ إضافة رابط "خطتي" للمستخدمين المسجلين
- ✅ تحديث القائمة المنسدلة للمستخدم

### 4. تحديث إدارة التفضيلات (`AppContext.js`) **جديد**
- ✅ حفظ التفضيلات في Supabase بدلاً من localStorage فقط
- ✅ استخدام `upsert` للتعامل مع المستخدمين الجدد تلقائياً
- ✅ جلب التفضيلات من Supabase عند تسجيل الدخول
- ✅ مزامنة التفضيلات المحلية مع قاعدة البيانات
- ✅ مسح التفضيلات عند تسجيل الخروج
- ✅ التعامل مع الأخطاء والحالات الاستثنائية

## الخطوات التالية المطلوبة:

### 1. إعداد قاعدة البيانات

#### أ) إنشاء جدول profiles
قم بتنفيذ الـ SQL script في Supabase:
```sql
-- انتقل إلى ملف: src/sql/create_profiles_table.sql
-- انسخ المحتوى وشغله في Supabase SQL Editor
```

#### ب) إنشاء جدول itineraries
```sql
-- انتقل إلى ملف: src/sql/create_itineraries_table.sql  
-- انسخ المحتوى وشغله في Supabase SQL Editor
```

### 2. إعداد Webhook في n8n
إنشاء webhook جديد بالرابط:
```
https://n8n.smart-tour.app/webhook/addToItinerary
```

**المطلوب في الـ workflow:**
1. استلام POST request مع البيانات:
   ```json
   {
     "userId": "uuid-here", 
     "destinationId": "petra"
   }
   ```

2. إضافة عقدة Supabase للإدراج:
   ```javascript
   // Supabase Insert Node
   Table: itineraries
   Data: {
     user_id: $json.userId,
     destination_id: $json.destinationId
   }
   // مع التعامل مع الأخطاء (duplicate entries)
   ```

### 3. اختبار النظام الكامل
1. **اختبار التفضيلات:**
   - تسجيل دخول مستخدم
   - تعديل التفضيلات في صفحة الملف الشخصي
   - تسجيل خروج وإعادة دخول للتحقق من حفظ التفضيلات

2. **اختبار إضافة الوجهات:**
   - فتح الشات بوت والسؤال عن وجهة
   - النقر على زر "أضف إلى خطتي"
   - زيارة صفحة `/my-plan` للتحقق

## الملفات المعدلة:
- `src/components/Chatbot.js` - إضافة زر "أضف إلى خطتي"
- `src/pages/MyPlan.js` - صفحة خطتي الجديدة
- `src/components/Header.js` - تحديث التنقل
- `src/App.js` - إضافة route الجديد
- `src/contexts/AppContext.js` - **تحديث إدارة التفضيلات مع Supabase**
- `src/sql/create_itineraries_table.sql` - SQL للوجهات
- `src/sql/create_profiles_table.sql` - **SQL للتفضيلات** 

## المميزات:
- ✅ متعدد اللغات (عربي/إنجليزي)
- ✅ تصميم responsive
- ✅ حماية البيانات (RLS في Supabase)
- ✅ UX سلس مع حالات التحميل
- ✅ تعامل مع الأخطاء
- ✅ تجنب التكرار في قاعدة البيانات
- ✅ **مزامنة التفضيلات عبر الأجهزة**
- ✅ **نسخ احتياطي في localStorage كـ fallback**

## كيف تعمل إدارة التفضيلات الجديدة:

### عند حفظ التفضيلات:
1. حفظ في الحالة المحلية (React state)
2. حفظ في localStorage كنسخة احتياطية
3. حفظ في Supabase للمزامنة عبر الأجهزة

### عند تسجيل الدخول:
1. جلب التفضيلات من Supabase أولاً
2. إذا لم توجد، استخدام localStorage
3. مزامنة localStorage مع Supabase

### عند تسجيل الخروج:
1. مسح التفضيلات من الذاكرة
2. مسح localStorage
